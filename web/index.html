<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Sessions - dill.dev</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 500;
            color: #4a9eff;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #888;
        }
        
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .session-card {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .session-card:hover {
            background: #353535;
            border-color: #4a9eff;
            transform: translateY(-2px);
        }
        
        .session-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .session-name {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #e0e0e0;
        }
        
        .session-status {
            font-size: 0.85rem;
            color: #888;
        }
        
        .session-status.active {
            color: #66bb6a;
        }
        
        .session-status.empty {
            color: #999;
        }
        
        footer {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid #404040;
            color: #666;
            font-size: 0.85rem;
        }

        .about {
            background: #242424;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0 1rem;
            line-height: 1.6;
            color: #cfcfcf;
        }

        .about h2 {
            font-size: 1.2rem;
            margin-bottom: 0.75rem;
            color: #4a9eff;
        }

        .about strong {
            color: #fff;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .error {
            background: #d32f2f;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cache Sessions</h1>
            <div class="subtitle">Select a session to access your encrypted scratch pad</div>
        </header>
        
        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Loading sessions...</div>
        <div id="sessions" class="sessions-grid" style="display: none;"></div>

        <section class="about">
            <h2>What is dill.dev/cache?</h2>
            <p>A quick, zero-knowledge scratch pad for moving snippets between machines when the clipboard can&apos;t. Each session encrypts entirely in your browser, so the server only ever stores ciphertext.</p>
            <p><strong>Encryption</strong>: AES-GCM with 256-bit keys derived via PBKDF2 (100k iterations) from a 40-bit entropy key phrase‚Äîover one trillion possible keys per session. Lose the key, lose the data.</p>
        </section>
        
        <footer>
            <p>10 independent encrypted sessions ‚Ä¢ Encryption key required for access</p>
            <p style="margin-top: 0.5rem;">Secured by client-side encryption</p>
        </footer>
    </div>

    <script>
        const SESSION_ICONS = {
            'blue-river': 'üîµ',
            'green-forest': 'üü¢',
            'red-canyon': 'üî¥',
            'golden-plains': 'üü°',
            'silver-lake': '‚ö™',
            'purple-mountain': 'üü£',
            'orange-sunset': 'üü†',
            'pink-cloud': 'üå∏',
            'brown-earth': 'üü§',
            'gray-storm': '‚ö´'
        };
        
        async function loadSessions() {
            try {
                const response = await fetch('/api/cache/sessions');
                if (!response.ok) throw new Error('Failed to load sessions');
                
                const data = await response.json();
                displaySessions(data.sessions);
            } catch (error) {
                showError('Error loading sessions: ' + error.message);
            }
        }
        
        function displaySessions(sessions) {
            const container = document.getElementById('sessions');
            const loading = document.getElementById('loading');
            
            container.innerHTML = '';
            
            sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card';
                card.onclick = () => openSession(session.id);
                
                const icon = SESSION_ICONS[session.id] || 'üìù';
                const statusText = session.has_data 
                    ? `Active ‚Ä¢ ${formatUpdatedText(session.updated)}`
                    : 'Empty ‚Ä¢ Click to create';
                const statusClass = session.has_data ? 'active' : 'empty';
                
                const statusAttr = session.updated ? ` data-updated="${session.updated}" data-state="${session.has_data ? 'active' : 'empty'}"` : '';
                card.innerHTML = `
                    <div class="session-icon">${icon}</div>
                    <div class="session-name">${session.name}</div>
                    <div class="session-status ${statusClass}"${statusAttr}>${statusText}</div>
                `;
                
                container.appendChild(card);
            });
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            refreshRelativeTimes();
        }
        
        function formatRelativeTime(date, now) {
            const diffMs = Math.max(0, now - date);
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            const weeks = Math.floor(diffDays / 7);
            if (weeks < 4) return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
            return null;
        }

        function formatUpdatedText(isoString, now = new Date()) {
            if (!isoString) return 'Never updated';
            const date = new Date(isoString);

            const absolute = date.toLocaleString([], {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const relative = formatRelativeTime(date, now);
            return relative ? `${absolute} (${relative})` : absolute;
        }

        function refreshRelativeTimes() {
            const now = new Date();
            document.querySelectorAll('.session-status[data-updated]').forEach(statusEl => {
                const iso = statusEl.getAttribute('data-updated');
                if (!iso) return;
                const state = statusEl.getAttribute('data-state');
                const prefix = state === 'active' ? 'Active' : 'Empty';
                const text = state === 'active'
                    ? `Active ‚Ä¢ ${formatUpdatedText(iso, now)}`
                    : 'Empty ‚Ä¢ Click to create';
                statusEl.textContent = text;
            });
        }

        function openSession(sessionId) {
            window.location.href = `session.html?id=${sessionId}`;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            setInterval(refreshRelativeTimes, 60000);
        });
    </script>
</body>
</html>
